<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">Game Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    </style>
</head>

<body>
    <div id="infomation-container">
                    <canvas id="infomation" width="800" height="100"></canvas>
    </div> 
    <div id="board-container" style="width: 800px; height: 800px; margin-bottom: 20px;">
        <canvas id="board" width="800" height="800"></canvas>
    </div>
    <div id="confidence-chart-container" style="width: 800px; height: 50px; margin-bottom: 20px;">
        <canvas id="confidence-chart" width="800" height="50"></canvas>
    </div>

    </div>

    <script>
        const socket = io('http://localhost:2468');
        const gobanVisual = document.getElementById('board');
        const gobaContext = gobanVisual.getContext('2d');

        const confidenceChart = document.getElementById('confidence-chart')
        const confContext = confidenceChart.getContext('2d')

        const playerInfo = document.getElementById('infomation')
        const infoContext = playerInfo.getContext('2d');

        // Double the internal size of the board
        gobanVisual.width = 1600;
        gobanVisual.height = 1600;

        // But keep the display size
        gobanVisual.style.width = '800px';
        gobanVisual.style.height = '800px';

        confidenceChart.width = 1600
        confidenceChart.height = 100

        confidenceChart.style.width = '800px'
        confidenceChart.style.height = '50px'

        playerInfo.width = 1600
        playerInfo.height = 200

        playerInfo.style.width = '800px'
        playerInfo.style.height = '100px'

        // Now you need to scale the drawing context
        gobaContext.scale(2, 2);
        confContext.scale(2, 2);
        infoContext.scale(2, 2);

        function drawBoard(moves) {
            const padding = 20;
            const boardSize = 800;
            const cellSize = boardSize / 19;
            const totalSize = boardSize + 2 * padding;  // Total canvas size including padding
            const letters = 'ABCDEFGHJKLMNOPQRST';
            // Draw background
            ctx.fillStyle = '#FFCC66';  // This is a light brown color
            ctx.fillRect(0, 0, totalSize, totalSize);

            // Draw lines centered with padding
            for (let i = 0; i < 19; i++) {
                ctx.beginPath();

                // Horizontal Lines
                ctx.moveTo(padding, padding + i * cellSize);
                ctx.lineTo(boardSize - padding - 2, padding + i * cellSize);

                // Vertical Lines
                ctx.moveTo(padding + i * cellSize, padding);
                ctx.lineTo(padding + i * cellSize, boardSize - padding - 2);

                ctx.strokeStyle = '#000';
                ctx.stroke();

                ctx.font = '16px Arial';  // You can adjust the font size and style as needed
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#000';  // Text color
                // Add letter labels for horizontal lines
                ctx.fillText(letters.charAt(i), padding + i * cellSize, boardSize - padding + 10); // The '-4' and '+15' are offsets to position the letters correctly
                // Add number labels for vertical lines (from 19 down to 1)
                ctx.fillText(String(19 - i), 8, padding + i * cellSize);  // The '4' offsets are to position the numbers correctly
            }

            // Draw moves
            moves.forEach(move => {
                const [x, y, color] = move;  // Assuming moves are structured as [x,y,color]

                ctx.beginPath();
                ctx.arc(padding + x * cellSize, padding + y * cellSize, cellSize / 1.65 - 5, 0, Math.PI * 2, false); // Minus 5 for a little padding

                if (color === 'b') {
                    ctx.fillStyle = 'black';
                    ctx.strokeStyle = 'black'
                    ctx.lineWidth = 2
                    ctx.stroke()
                } else if (color === 'w') {
                    ctx.strokeStyle = 'black'
                    ctx.lineWidth = 2
                    ctx.stroke()
                    ctx.fillStyle = 'white';
                } else if (color === 'a') {
                    ctx.fillStyle = 'lightblue';
                    ctx.strokeStyle = 'black'
                    ctx.lineWidth = 2
                    ctx.stroke()
                }

                ctx.fill();
            });
        }

        function updateEvaluations(evaluations){
            const evalConfidence = evaluations.confidence
            const winrate = evaluations.winrate
            const territory = evaluations.territory
            const aiScore = evaluations.score
            const lastMoveValue = evaluations.lastMoveValue

            updateWinrate(winrate)
            updateConfidenceChart(evalConfidence)
            updateLastMove(lastMoveValue)
        }


        socket.on('connect', () => {
            document.getElementById('status').textContent = 'Connected';
        });

        socket.on('error', (err) => { console.log(err) })

        socket.on('disconnect', () => {
            document.getElementById('status').textContent = 'Disconnected';
        });

        const pathSegments = window.location.pathname.split('/');
        const type = pathSegments[1];
        const id = pathSegments[2];
        const eventName = `${type}/${id}`;
        console.log(eventName)
        document.getElementById('title').textContent = eventName

        drawBoard([[15, 3, "b"], [15, 2, "w"], [3, 3, "a"]])

        socket.on(eventName, (data) => {
            const newData = JSON.parse(data);
            console.log(`Received data for ${eventName}:`, newData);
            const boardData = newData.board
            const evaluations = newData.evaluation

            updateBoardvisual(boardData)
            updateEvaluations(evaluations)

        });


    </script>
</body>

</html>